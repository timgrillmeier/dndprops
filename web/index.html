<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DM Mob Forge — Single-File D&D Prop Page</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root { --accent:#7bdcb5; --muted:#9aa0a6; }
    body{
      min-height:100vh;
      background:radial-gradient(1200px 800px at 10% -20%, rgba(123,220,181,.06), transparent) no-repeat,
                 radial-gradient(1000px 900px at 90% 120%, rgba(123,220,181,.05), transparent) no-repeat;
    }
    .navbar-brand b{letter-spacing:.5px}
    .form-hint{font-size:.85rem;color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .5rem;border-radius:999px;background:#1f2328;border:1px solid #2a2f36;font-size:.8rem}
    .stat{display:flex;flex-direction:column;align-items:center;justify-content:center;width:64px;padding:.25rem;border-radius:.5rem;border:1px solid #2c3138;background:#15181c}
    .stat .v{font-weight:700;font-size:1.05rem}
    .stat .m{color:var(--muted);font-size:.8rem}
    .mob-card{border:1px solid #2a2f36;background:#0f1114}
    .mob-card h3{font-size:1.125rem}
    .hp-input{width:85px}
    .tight-input{width:64px}
    .monosmall{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.95rem}
    .toast-overlay{position:fixed;right:1rem;top:4.5rem;z-index:1080;display:flex;flex-direction:column;gap:.5rem;width:min(480px,92vw)}
    .toast .progress{height:.2rem}
    .kbd{border:1px solid #2a2f36;padding:.1rem .35rem;border-radius:.25rem;background:#0b0d10}
    .list-divider{height:1px;background:linear-gradient(to right,transparent,#2a2f36 30%,#2a2f36 70%,transparent);margin:1rem 0}
    .pill{border:1px solid #2a2f36;border-radius:999px;padding:.15rem .5rem;font-size:.8rem;background:#0f1114}
    .strike-dead{text-decoration:line-through;color:#7c8794}
    .inventory-list{list-style:none;padding-left:1rem}
    #mobsArea{max-height:calc(100vh - 260px);overflow:auto;padding-bottom:1rem}
    .sticky-top-2{position:sticky;top:4rem;z-index:5;background:rgba(10,12,15,.85);backdrop-filter:blur(3px)}
    .table-smaller td,.table-smaller th{padding:.25rem .5rem}
    .banner{background:#1d1f24;border-bottom:1px solid #2a2f36}
  </style>
</head>
<body>

  <!-- Optional banner to warn about file:// -->
  <div id="banner" class="banner py-1 px-3 small d-none">
    <i class="bi bi-exclamation-triangle text-warning"></i>
    You’re running this from <code>file://</code>. Some browsers block API requests here. If generation fails, serve via a local web server or GitHub Pages.
  </div>

  <!-- ===== Top Nav ===== -->
  <nav class="navbar navbar-expand-lg border-bottom border-secondary-subtle sticky-top" style="backdrop-filter: blur(6px); background:rgba(10,12,15,.9);">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <i class="bi bi-shield-shaded text-success"></i>
        <span>DM <b>Mob Forge</b></span>
        <span class="pill ms-2 monosmall">Single-file</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topbar"><span class="navbar-toggler-icon"></span></button>

      <div class="collapse navbar-collapse" id="topbar">
        <!-- API Key + Generate -->
        <form class="d-flex align-items-end gap-2 ms-auto order-lg-2 mt-3 mt-lg-0" onsubmit="return false;">
          <div>
            <label class="form-label m-0">OpenAI API key</label>
            <input id="apiKey" type="password" class="form-control form-control-sm" placeholder="sk-..." autocomplete="off">
            <div class="form-hint">Stored in a cookie on this device.</div>
          </div>
          <div class="d-flex gap-2">
            <button id="btnSaveKey" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-key"></i> Save</button>
            <button id="btnForgetKey" class="btn btn-outline-warning btn-sm" type="button"><i class="bi bi-eraser"></i> Forget</button>
            <button id="btnGenerate" class="btn btn-success btn-sm" type="button"><i class="bi bi-stars"></i> Generate</button>
          </div>
        </form>

        <!-- Generator Controls -->
        <div class="w-100 order-lg-1">
          <div class="row g-3 mt-3">
            <div class="col-6 col-md-2">
              <label class="form-label m-0">Target level</label>
              <input id="levelTarget" type="number" class="form-control form-control-sm" min="0" value="3">
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label m-0">Level variation ±</label>
              <input id="levelVariation" type="number" class="form-control form-control-sm" min="0" value="1">
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label m-0">Wealth</label>
              <select id="wealthTier" class="form-select form-select-sm">
                <option>Poor</option><option selected>Modest</option><option>Comfortable</option><option>Wealthy</option><option>Opulent</option>
              </select>
            </div>
            <div class="col-12 col-md-5">
              <label class="form-label m-0">Style tags</label>
              <div class="d-flex flex-wrap gap-2">
                <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="dungeon" id="style1" checked><label class="form-check-label" for="style1">Dungeon</label></div>
                <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="forest raiders" id="style2"><label class="form-check-label" for="style2">Forest raiders</label></div>
                <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="city gang" id="style3"><label class="form-check-label" for="style3">City gang</label></div>
                <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" value="city guard" id="style4"><label class="form-check-label" for="style4">City guard</label></div>
                <input id="styleFree" class="form-control form-control-sm flex-grow-1" placeholder="Add custom tags, comma-separated">
              </div>
            </div>

            <div class="col-12 col-lg-7">
              <label class="form-label m-0">Species</label>
              <select id="speciesSelect" class="form-select form-select-sm" multiple size="4" aria-label="Species">
                <option value="Mixed">Mixed</option>
                <option>Human</option><option>Elf</option><option>Dwarf</option><option>Halfling</option>
                <option>Gnome</option><option>Half-Elf</option><option>Half-Orc</option><option>Tiefling</option>
                <option>Dragonborn</option><option>Goliath</option><option>Firbolg</option><option>Tabaxi</option>
                <option>Kobold</option><option>Goblin</option><option>Orc</option><option>Lizardfolk</option>
                <option>Aasimar</option><option>Triton</option><option>Genasi</option><option>Kenku</option>
                <option>Bugbear</option><option>Yuan-ti</option><option>Tortle</option><option>Warforged</option>
                <option>Shifter</option><option>Changeling</option><option>Leonin</option><option>Satyr</option>
                <option>Hobgoblin</option><option>Vedalken</option><option>Minotaur</option><option>Centaur</option>
                <option>Simic Hybrid</option>
              </select>
              <div class="form-hint">Hold <span class="kbd">Ctrl</span>/<span class="kbd">Cmd</span> to select multiples.</div>
            </div>

            <div class="col-12 col-lg-5">
              <label class="form-label m-0">Party (optional)</label>
              <div class="row g-2">
                <div class="col-4"><input id="pcCount" type="number" class="form-control form-control-sm" min="1" value="4"><div class="form-hint">PCs</div></div>
                <div class="col-4"><input id="avgLevel" type="number" class="form-control form-control-sm" min="1" value="3"><div class="form-hint">Average level</div></div>
                <div class="col-4">
                  <select id="difficulty" class="form-select form-select-sm">
                    <option>Any</option><option>Easy</option><option selected>Medium</option><option>Hard</option><option>Deadly</option>
                  </select>
                  <div class="form-hint">Encounter target</div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- /w-100 -->
      </div><!-- /collapse -->
    </div>
  </nav>

  <!-- ===== Main Content ===== -->
  <div class="container-fluid mt-3">
    <div class="row g-3">
      <aside class="col-12 col-lg-4 col-xxl-3">
        <div class="card border-secondary-subtle">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2"><i class="bi bi-list-ol text-info"></i><strong>Initiative</strong></div>
            <div class="d-flex gap-2">
              <button id="btnRollAllInit" class="btn btn-outline-info btn-sm" type="button"><i class="bi bi-dice-5"></i> Roll mobs</button>
              <button id="btnClearInits" class="btn btn-outline-secondary btn-sm" type="button"><i class="bi bi-eraser"></i></button>
            </div>
          </div>
          <div class="card-body">
            <h6 class="text-secondary">Players</h6>
            <div id="playersList" class="vstack gap-2"></div>
            <div class="mt-2 d-flex gap-2">
              <input id="playerName" class="form-control form-control-sm" placeholder="Name">
              <input id="playerInit" class="form-control form-control-sm tight-input" placeholder="Init" inputmode="numeric">
              <button id="btnAddPlayer" class="btn btn-outline-primary btn-sm" type="button"><i class="bi bi-plus-lg"></i></button>
            </div>
            <div class="list-divider"></div>
            <h6 class="text-secondary">Order</h6>
            <div id="initiativeOrder" class="small"></div>
          </div>
        </div>

        <div class="card border-secondary-subtle mt-3">
          <div class="card-header d-flex align-items-center gap-2"><i class="bi bi-arrow-repeat text-warning"></i><strong>Export / Import</strong></div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button id="btnExport" class="btn btn-outline-light btn-sm" type="button"><i class="bi bi-download"></i> Export JSON</button>
              <button id="btnImport" class="btn btn-outline-light btn-sm" type="button"><i class="bi bi-upload"></i> Import JSON</button>
              <button id="btnSaveAll" class="btn btn-outline-success btn-sm" type="button"><i class="bi bi-save"></i> Save all</button>
              <button id="btnForgetAll" class="btn btn-outline-danger btn-sm" type="button"><i class="bi bi-trash"></i> Forget all</button>
            </div>
          </div>
        </div>
      </aside>

      <main class="col-12 col-lg-8 col-xxl-9">
        <div class="sticky-top-2 py-2">
          <div class="d-flex gap-2 align-items-center">
            <i class="bi bi-people text-success"></i><strong>Generated mobs</strong>
            <span id="mobCount" class="badge text-bg-dark border border-secondary-subtle">0</span>
            <div class="ms-auto d-flex gap-2 align-items-center">
              <div class="form-check form-check-inline"><input class="form-check-input filterAlive" type="checkbox" id="filterAlive" checked><label class="form-check-label" for="filterAlive">Alive</label></div>
              <div class="form-check form-check-inline"><input class="form-check-input filterAlive" type="checkbox" id="filterDown" checked><label class="form-check-label" for="filterDown">Down</label></div>
              <div class="form-check form-check-inline"><input class="form-check-input filterAlive" type="checkbox" id="filterDead" checked><label class="form-check-label" for="filterDead">Dead</label></div>
              <div class="input-group input-group-sm" style="width:260px;">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input id="searchInput" class="form-control" placeholder="Search">
                <button id="btnClearSearch" class="btn btn-outline-secondary" type="button"><i class="bi bi-x-lg"></i></button>
              </div>
            </div>
          </div>
        </div>
        <div id="mobsArea" class="mt-2"></div>
      </main>
    </div>
  </div>

  <div id="toastOverlay" class="toast-overlay"></div>

  <div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title"><i class="bi bi-download"></i> Export JSON</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><textarea id="exportText" class="form-control monosmall" rows="12" readonly></textarea></div>
      <div class="modal-footer"><button id="btnCopyExport" class="btn btn-outline-light"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div></div>
  </div>

  <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title"><i class="bi bi-upload"></i> Import JSON</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><textarea id="importText" class="form-control monosmall" rows="12" placeholder="{...}"></textarea></div>
      <div class="modal-footer"><button id="btnDoImport" class="btn btn-success"><i class="bi bi-check2-circle"></i> Import</button><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button></div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------- helpers: cookies ----------
    function setCookie(name, value, days=365){const expires=new Date(Date.now()+days*864e5).toUTCString();document.cookie=name+'='+encodeURIComponent(value)+'; expires='+expires+'; path=/; SameSite=Lax'}
    function getCookie(name){return document.cookie.split('; ').reduce((r,v)=>{const p=v.split('=');return p[0]===name?decodeURIComponent(p[1]):r},'')}
    function eraseCookie(name){document.cookie=name+'=; Max-Age=-99999999; path=/'}

    // ---------- misc utils ----------
    function uuidv4(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)})}
    function modFromStat(stat){return Math.floor((Number(stat||10)-10)/2)}
    function rollDice(spec){ // "2d6+3" etc.
      const parts=spec.split(/(?=[+-])/g).map(s=>s.trim()); let total=0, breakdown=[];
      let sign=+1;
      for (let p of parts){
        if(!p)continue;
        if(p[0]==='+'){sign=+1;p=p.slice(1).trim()} else if(p[0]==='-'){sign=-1;p=p.slice(1).trim()} else sign=+1;
        const m=p.match(/^(\d*)d(\d+)$/i);
        if(m){const k=sign*(m[1]?+m[1]:1), faces=+m[2], rolls=[]; for(let i=0;i<Math.abs(k);i++){rolls.push(1+Math.floor(Math.random()*faces))} const s=rolls.reduce((a,b)=>a+b,0)*Math.sign(k); total+=s; breakdown.push(`${Math.sign(k)<0?'-':''}${Math.abs(k)}d${faces}[${rolls.join(',')}]`)}
        else if(/^\d+$/.test(p)){total+=sign*+p; breakdown.push(`${sign>0?'+':''}${sign*+p}`)}
      }
      return {total, breakdown:breakdown.join(' ')}
    }
    function rollD20(mod=0){const r1=1+Math.floor(Math.random()*20), r2=1+Math.floor(Math.random()*20); return {total:r1+mod, raw:r1, mod, pair:[r1,r2], note:''}}

    // ---------- toasts ----------
    function showActionToast({title="Action", body="Result", durationMs=60000}){
      const toast=document.createElement('div'); toast.className='toast text-bg-dark border border-secondary-subtle'; toast.role='alert';
      toast.innerHTML=`<div class="toast-header bg-dark text-white border-0">
          <i class="bi bi-bullseye me-2 text-success"></i><strong class="me-auto">${title}</strong>
          <small>now</small><button class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
        </div><div class="toast-body">${body}</div>
        <div class="progress mt-2"><div class="progress-bar" role="progressbar" style="width:100%;transition:width ${durationMs}ms linear;"></div></div>`;
      document.getElementById('toastOverlay').prepend(toast);
      const t=new bootstrap.Toast(toast,{autohide:true,delay:durationMs}); t.show();
      requestAnimationFrame(()=>toast.querySelector('.progress-bar').style.width='0%');
      toast.addEventListener('hidden.bs.toast',()=>toast.remove());
    }

    // ---------- schema/state ----------
    const SCHEMA_VERSION=1;
    let appState={schemaVersion:SCHEMA_VERSION, party:{pcCount:4,averageLevel:3,playersInitiative:[]},
      encounter:{seed:"",style:["dungeon"],species:["Human"],wealthTier:"Modest",levelTarget:3,levelVariation:1,mix:"balanced",difficulty:"Medium"}, mobs:[]};
    const CK_API_KEY='openai_api_key', CK_APP_STATE='encounterState_v1', CK_MOB_INDEX='mobIndex_v1';

    function saveStateToCookie(){try{setCookie(CK_APP_STATE, JSON.stringify(appState))}catch(e){alert('Could not save state to cookies. Consider exporting JSON.')} }
    function loadStateFromCookie(){try{const s=getCookie(CK_APP_STATE); if(s){const parsed=JSON.parse(s); appState=(parsed.schemaVersion===SCHEMA_VERSION)?parsed:Object.assign({schemaVersion:SCHEMA_VERSION},parsed)}}catch(e){console.warn('Load cookie failed',e)}}

    // ---------- DOM helpers ----------
    const $=sel=>document.querySelector(sel); const $$=sel=>Array.from(document.querySelectorAll(sel));
    function el(tag, attrs={}, ...children){const n=document.createElement(tag); for(const [k,v] of Object.entries(attrs||{})){if(k==='class')n.className=v; else if(k.startsWith('on')&&typeof v==='function')n.addEventListener(k.slice(2),v); else if(v!==null&&v!==undefined)n.setAttribute(k,v)} children.forEach(c=>n.append(c)); return n}

    // ---------- players / initiative ----------
    function renderPlayers(){const wrap=$('#playersList'); wrap.innerHTML=''; appState.party.playersInitiative.forEach((p,i)=>{
      wrap.append(el('div',{class:'d-flex gap-2 align-items-center'},
        el('input',{class:'form-control form-control-sm',value:p.name,oninput:e=>{p.name=e.target.value;saveStateToCookie();renderInitiativeOrder()}}),
        el('input',{class:'form-control form-control-sm tight-input',value:p.init??'',inputmode:'numeric',oninput:e=>{p.init=Number(e.target.value)||'';saveStateToCookie();renderInitiativeOrder()}}),
        el('button',{class:'btn btn-outline-danger btn-sm',onclick:()=>{appState.party.playersInitiative.splice(i,1);saveStateToCookie();renderPlayers();renderInitiativeOrder()}}, el('i',{class:'bi bi-x-lg'}))
      ))
    })}
    function renderInitiativeOrder(){const view=$('#initiativeOrder'); const entries=[];
      for(const p of appState.party.playersInitiative){ if(p.name && p.init!=='' && p.init!==undefined) entries.push({name:`${p.name} (PC)`,init:Number(p.init)||0})}
      for(const m of appState.mobs){ if(m.initiative!=='' && m.initiative!==undefined) entries.push({name:m.name,init:Number(m.initiative)||0})}
      entries.sort((a,b)=>b.init-a.init);
      if(!entries.length){view.innerHTML='<span class="text-secondary">No initiatives yet.</span>';return}
      const tbl=el('table',{class:'table table-dark table-sm table-smaller align-middle mb-0'});
      tbl.append(el('thead',{},el('tr',{},el('th',{},'Init'),el('th',{},'Name'))),
                 el('tbody',{},...entries.map(e=>el('tr',{},el('td',{},e.init),el('td',{},e.name)))));
      view.innerHTML=''; view.append(tbl);
    }
    function rollAllMobInitiatives(){for(const m of appState.mobs){const dex=Number(m.stats?.dex??10); m.initiative=rollD20(modFromStat(dex)).total} saveStateToCookie(); renderMobs(); renderInitiativeOrder()}

    // ---------- mobs rendering ----------
    function statusOfMob(m){ if(m.hp.current<=0 && (m.deathSaves?.fail??0)>=3) return 'dead'; if(m.hp.current<=0) return 'down'; return 'alive' }
    function renderStatBlock(stats){const row=el('div',{class:'d-flex flex-wrap gap-2'});
      for(const k of ['str','dex','con','int','wis','cha']){const v=Number(stats?.[k]??10), mod=modFromStat(v);
        row.append(el('div',{class:'stat'}, el('div',{class:'text-secondary text-uppercase',style:'font-size:.7rem;letter-spacing:.05rem;'},k), el('div',{class:'v'},String(v)), el('div',{class:'m'}, (mod>=0?'+':'')+mod)))}
      return row}
    function renderCoins(coins){const c=coins||{}; return el('div',{class:'d-flex flex-wrap gap-2 monosmall'},
      el('span',{class:'pill'},`cp ${c.cp||0}`), el('span',{class:'pill'},`sp ${c.sp||0}`), el('span',{class:'pill'},`gp ${c.gp||0}`), el('span',{class:'pill'},`pp ${c.pp||0}`))}


    function renderActionList(mob, list) {
      const arr = Array.isArray(list) ? list : [];
      if (!arr.length) return el('div', { class: 'text-secondary small' }, '—');

      const wrap = el('div', { class: 'vstack gap-2' });
      arr.forEach((a, idx) => {
        const btn = el('button', { class: 'btn btn-outline-light btn-sm' }, a.name || `Action ${idx + 1}`);
        btn.addEventListener('click', () => performAction(mob, a));

        const meta = [];
        if (a.type) meta.push(a.type);
        if (a.range) meta.push(a.range);
        if (a.attackBonus !== undefined && a.attackBonus !== null) meta.push(`+${a.attackBonus} to hit`);
        if (Array.isArray(a.damage) && a.damage.length) meta.push(a.damage.map(d => `${d.dice}${d.type ? (' ' + d.type) : ''}`).join(' + '));

        const desc = el('div', { class: 'small text-secondary' }, meta.join(' • ') || '—');
        wrap.append(el('div', { class: 'd-grid gap-1' }, btn, desc));
        if (a.notes) wrap.append(el('div', { class: 'small' }, a.notes));
      });
      return wrap;
    }




    function renderConditionsEditor(m){const ALL=['blinded','charmed','deafened','frightened','grappled','incapacitated','invisible','paralyzed','petrified','poisoned','prone','restrained','stunned','unconscious'];
      const row=el('div',{class:'d-flex flex-wrap gap-2'}); const conds=new Set(m.conditions||[]);
      ALL.forEach(c=>{const chip=el('span',{class:'chip pointer '+(conds.has(c)?'border-success':'' )},el('i',{class:'bi bi-dot'}),c);
        chip.addEventListener('click',()=>{ if(conds.has(c)) conds.delete(c); else conds.add(c); m.conditions=Array.from(conds); saveStateToCookie(); renderMobs();});
        row.append(chip)}); return row}
    function renderDeathSaves(m){m.deathSaves=m.deathSaves||{success:0,fail:0}; const w=el('div',{class:'d-flex align-items-center gap-2'});
      const s=m.deathSaves.success||0, f=m.deathSaves.fail||0; const pill=(filled,t)=>el('span',{class:'chip '+(filled?(t==='s'?'border-success':'border-danger'):'')}, t==='s'?'S':'F');
      w.append(pill(s>=1,'s'),pill(s>=2,'s'),pill(s>=3,'s'),el('span',{},' '),pill(f>=1,'f'),pill(f>=2,'f'),pill(f>=3,'f')); return w}
    function renderMobCard(m){
      const card=el('div',{class:'card mob-card mb-3',id:`mob_${m.id}`});
      const header=el('div',{class:'card-header d-flex align-items-center justify-content-between gap-2'},
        el('div',{class:'d-flex align-items-center gap-2'}, el('h3',{class:'m-0 '+(statusOfMob(m)==='dead'?'strike-dead':'')}, m.name||'Unnamed'), el('span',{class:'pill monosmall'},`Lvl ${m.level??'?'} • AC ${m.ac??'?'}`)),
        el('div',{class:'d-flex gap-2'}, el('button',{class:'btn btn-outline-success btn-sm',title:'Save to cookie',onclick:()=>saveMobIndividually(m)}, el('i',{class:'bi bi-bookmark-check'})), el('button',{class:'btn btn-outline-danger btn-sm',title:'Delete from list',onclick:()=>deleteMob(m.id)}, el('i',{class:'bi bi-trash'}))))
      const body=el('div',{class:'card-body vstack gap-3'});
      const hpRow=el('div',{class:'row g-3 align-items-end'},
        el('div',{class:'col-6 col-md-4'}, el('label',{class:'form-label m-0'},'HP (cur / max / temp)'),
          el('div',{class:'d-flex align-items-center gap-2'},
            el('input',{class:'form-control form-control-sm hp-input',value:m.hp?.current??0,inputmode:'numeric',oninput:e=>{m.hp.current=Number(e.target.value)||0;saveStateToCookie();renderInitiativeOrder();renderMobs();}}),
            el('span',{},'/'),
            el('input',{class:'form-control form-control-sm hp-input',value:m.hp?.max??0,inputmode:'numeric',oninput:e=>{m.hp.max=Number(e.target.value)||0;saveStateToCookie();renderMobs();}}),
            el('span',{},'+'),
            el('input',{id:`dmg_${m.id}`,class:'form-control form-control-sm tight-input',value:m.hp?.temp??0,inputmode:'numeric',oninput:e=>{m.hp.temp=Number(e.target.value)||0;saveStateToCookie();renderMobs();}})),
          el('div',{class:'mt-2 d-flex gap-2'}, el('input',{class:'form-control form-control-sm tight-input',placeholder:'Amount',inputmode:'numeric',id:`amt_${m.id}`}),
            el('button',{class:'btn btn-outline-danger btn-sm',onclick:()=>applyDamageHeal(m.id,'damage')},'Damage'),
            el('button',{class:'btn btn-outline-success btn-sm',onclick:()=>applyDamageHeal(m.id,'heal')},'Heal')),
          el('div',{class:'form-hint'},'At 0 HP: use Death Saves below, or mark Dead.')),
        el('div',{class:'col-6 col-md-2'}, el('label',{class:'form-label m-0'},'Initiative'),
          el('input',{class:'form-control form-control-sm',value:m.initiative??'',inputmode:'numeric',oninput:e=>{m.initiative=Number(e.target.value)||'';saveStateToCookie();renderInitiativeOrder();}})),
        el('div',{class:'col-6 col-md-2'}, el('label',{class:'form-label m-0'},'AC'),
          el('input',{class:'form-control form-control-sm',value:m.ac??'',inputmode:'numeric',oninput:e=>{m.ac=Number(e.target.value)||'';saveStateToCookie();}})),
        el('div',{class:'col-6 col-md-4'}, el('label',{class:'form-label m-0'},'Movement'),
          el('input',{class:'form-control form-control-sm',value:(m.movement?.walk??30),oninput:e=>{m.movement=m.movement||{};m.movement.walk=e.target.value;saveStateToCookie();}}))
      );
      const statsRow=el('div',{class:'vstack gap-2'}, el('div',{class:'d-flex align-items-center gap-2'}, el('i',{class:'bi bi-activity text-info'}), el('strong',{},'Ability Scores')), renderStatBlock(m.stats||{}));
      const traitsRow=el('div',{class:'row g-3'},
        el('div',{class:'col-12 col-md-6'}, el('div',{class:'d-flex align-items-center gap-2 mb-1'}, el('i',{class:'bi bi-stars text-warning'}), el('strong',{},'Traits')), el('ul',{class:'small mb-0'}, ...(m.traits||[]).map(t=>el('li',{}, el('strong',{},t.name+': '), t.text||'')))),
        el('div',{class:'col-6 col-md-3'}, el('div',{class:'d-flex align-items-center gap-2 mb-1'}, el('i',{class:'bi bi-ear text-secondary'}), el('strong',{},'Senses')), el('div',{class:'small'}, m.senses||'—')),
        el('div',{class:'col-6 col-md-3'}, el('div',{class:'d-flex align-items-center gap-2 mb-1'}, el('i',{class:'bi bi-translate text-secondary'}), el('strong',{},'Languages')), el('div',{class:'small'}, (m.languages||['—']).join(', ')))
      );
      const actionRow=el('div',{class:'row g-3'},
        el('div',{class:'col-12 col-lg-6'}, el('div',{class:'d-flex align-items-center gap-2 mb-1'}, el('i',{class:'bi bi-lightning-charge text-danger'}), el('strong',{},'Actions')), renderActionList(m,m.actions||[])),
        el('div',{class:'col-12 col-lg-6'}, el('div',{class:'d-flex align-items-center gap-2 mb-1'}, el('i',{class:'bi bi-magic text-primary'}), el('strong',{},'Spells')), renderActionList(m,m.spells||[]))
      );
      const bottomRow=el('div',{class:'row g-3 align-items-start'},
        el('div',{class:'col-12 col-md-6'}, el('div',{class:'d-flex align-items-center gap-2 mb-1'}, el('i',{class:'bi bi-bag text-success'}), el('strong',{},'Inventory & Coins')), el('div',{}, renderCoins(m.inventory?.coins)), el('ul',{class:'inventory-list mt-2 small'}, ...((m.inventory?.items)||[]).map(it=>el('li',{},'• ',it)))),
        el('div',{class:'col-12 col-md-6 vstack gap-2'},
          el('div',{class:'d-flex align-items-center gap-2'}, el('i',{class:'bi bi-exclamation-octagon text-warning'}), el('strong',{},'Conditions')), renderConditionsEditor(m),
          el('div',{class:'d-flex align-items-center gap-2 mt-2'}, el('i',{class:'bi bi-heart-pulse text-danger'}), el('strong',{},'Death Saves'), renderDeathSaves(m), el('button',{class:'btn btn-outline-secondary btn-sm ms-auto',onclick:()=>rollDeathSave(m)},'Roll Death Save')),
          el('div',{class:'d-flex align-items-center gap-2 mt-2'}, el('i',{class:'bi bi-bullseye text-info'}), el('strong',{},'Concentration'),
            el('div',{class:'form-check form-switch ms-2'}, el('input',{class:'form-check-input',type:'checkbox',checked:!!m.concentration,onchange:e=>{m.concentration=e.target.checked?(m.concentration||{spell:'',dc:10}):null;saveStateToCookie();renderMobs();}})),
            m.concentration? el('input',{class:'form-control form-control-sm',placeholder:'Spell / DC',value:`${m.concentration.spell||''} / DC ${m.concentration.dc||10}`,oninput:e=>{const [sp,dc]=e.target.value.split('/'); m.concentration.spell=(sp||'').trim(); const dcm=/\d+/.exec(dc||''); m.concentration.dc=dcm?Number(dcm[0]):10; saveStateToCookie();}}) : el('span',{class:'text-secondary small'},'Off')),
          el('div',{class:'mt-2'}, el('label',{class:'form-label m-0'},'Notes'), el('textarea',{class:'form-control form-control-sm',rows:'2',value:m.notes||'',oninput:e=>{m.notes=e.target.value;saveStateToCookie();}}))
        )
      );
      body.append(hpRow,statsRow,traitsRow,actionRow,bottomRow); card.append(header,body); return card
    }
    function renderMobs(){
      const area=$('#mobsArea'); area.innerHTML='';
      const filters={alive:$('#filterAlive').checked,down:$('#filterDown').checked,dead:$('#filterDead').checked,search:($('#searchInput').value||'').trim().toLowerCase()};
      const allMobs = Array.isArray(appState.mobs) ? appState.mobs : [];
      const mobsSorted = [...allMobs].sort((a, b) => (a.name || '').localeCompare(b.name || ''));

      const visible=mobsSorted.filter(m=>{const s=statusOfMob(m);
        if(s==='alive'&&!filters.alive) return false; if(s==='down'&&!filters.down) return false; if(s==='dead'&&!filters.dead) return false;
        if(filters.search){const blob=[m.name,...(m.traits?.map(t=>t.name)||[]),...(appState.encounter?.style||[])].join(' ').toLowerCase(); if(!blob.includes(filters.search)) return false}
        return true});
      $('#mobCount').textContent=String(appState.mobs.length); visible.forEach(m=>area.append(renderMobCard(m)));
    }

    // ---------- combat actions ----------
    function performAction(m,a){
      let html=`<div class="monosmall">`;
      if(a.attackBonus!==undefined){const mod=Number(a.attackBonus)||0; const r=rollD20(mod); html+=`<div><strong>Attack:</strong> d20${mod>=0?'+':''}${mod} → <b>${r.total}</b> (raw ${r.raw})</div><div class="small text-secondary">Compare against target AC.</div>`}
      if(a.save?.dc){html+=`<div><strong>Save:</strong> ${a.save.ability||'—'} DC ${a.save.dc}</div>`}
      if(a.damage?.length){const parts=[]; for(const d of a.damage){const r=rollDice(d.dice); parts.push(`${d.dice}${d.type?(' '+d.type):''} → <b>${r.total}</b> <span class="text-secondary">[${r.breakdown}]</span>`)} html+=`<div><strong>Damage:</strong> ${parts.join(' + ')}</div>`}
      if(a.effect) html+=`<div class="mt-1"><strong>Effect:</strong> ${a.effect}</div>`; if(a.notes) html+=`<div class="text-secondary small">${a.notes}</div>`; html+=`</div>`;
      showActionToast({title:`${m.name}: ${a.name}`,body:html,durationMs:60000});
    }
    function applyDamageHeal(id,kind){
      const m=appState.mobs.find(x=>x.id===id); if(!m) return;
      const amt=Number(document.getElementById(`amt_${id}`).value||0); if(!amt) return;
      if(kind==='damage'){let remaining=amt; const temp=Number(m.hp.temp||0); if(temp>0){const use=Math.min(temp,remaining); m.hp.temp=temp-use; remaining-=use} m.hp.current=Math.max(0, Number(m.hp.current||0)-remaining)}
      else {m.hp.current=Math.min(Number(m.hp.max||0), Number(m.hp.current||0)+amt)}
      document.getElementById(`amt_${id}`).value=''; if(m.hp.current<=0 && !m.deathSaves) m.deathSaves={success:0,fail:0};
      saveStateToCookie(); renderMobs(); renderInitiativeOrder()
    }
    function rollDeathSave(m){const r=1+Math.floor(Math.random()*20);
      if(r===1) m.deathSaves.fail=Math.min(3,(m.deathSaves.fail||0)+2);
      else if(r===20){m.hp.current=1; m.deathSaves={success:0,fail:0}}
      else if(r>=10) m.deathSaves.success=Math.min(3,(m.deathSaves.success||0)+1);
      else m.deathSaves.fail=Math.min(3,(m.deathSaves.fail||0)+1);
      if((m.deathSaves.success||0)>=3){m.hp.current=0}
      saveStateToCookie(); renderMobs();
      showActionToast({title:`${m.name}: Death Save`, body:`<div class="monosmall">Roll = <b>${r}</b><br>S:${m.deathSaves.success||0} F:${m.deathSaves.fail||0}</div>`, durationMs:15000});
    }

    // ---------- per-mob save/delete ----------
    function getMobIndex(){try{return JSON.parse(getCookie(CK_MOB_INDEX)||'[]')}catch{return[]}}
    function setMobIndex(a){setCookie(CK_MOB_INDEX, JSON.stringify(a))}
    function saveMobIndividually(m){const idx=getMobIndex(); if(!idx.includes(m.id)){idx.push(m.id); setMobIndex(idx)} setCookie('mob_'+m.id, JSON.stringify(m)); showActionToast({title:'Saved',body:`<div class="monosmall">${m.name} saved to cookies.</div>`,durationMs:5000})}
    function deleteMob(id){const i=appState.mobs.findIndex(x=>x.id===id); if(i>=0) appState.mobs.splice(i,1); saveStateToCookie(); renderMobs(); renderInitiativeOrder()}

    // ---------- export/import ----------
    function exportJSON(){const obj=JSON.parse(JSON.stringify(appState)); $('#exportText').value=JSON.stringify(obj,null,2); new bootstrap.Modal('#exportModal').show()}
    function importJSONFromText(){const txt=$('#importText').value; try{const obj=JSON.parse(txt); if(!obj||!obj.mobs) throw new Error('Invalid structure'); appState=obj; saveStateToCookie(); renderPlayers(); renderMobs(); renderInitiativeOrder(); bootstrap.Modal.getInstance('#importModal')?.hide()}catch(e){alert('Invalid JSON.')}}

    // ---------- OpenAI generation (Chat Completions with fallbacks) ----------
    function normalizeMob(m) {
  // Coerce movement to object { walk: number }
  let movement = m.movement;
  if (typeof movement === 'number') {
    movement = { walk: movement };
  } else if (!movement || typeof movement !== 'object') {
    movement = { walk: 30 };
  }

  // Coerce senses to a readable string
  let senses = m.senses;
  if (senses && typeof senses === 'object') {
    // Flatten common fields
    const parts = [];
    for (const [k, v] of Object.entries(senses)) {
      parts.push(`${k}: ${v}`);
    }
    senses = parts.join(', ');
  }
  if (!senses || typeof senses !== 'string') senses = '—';

  // Ensure arrays are arrays
  const toArr = (x) => Array.isArray(x) ? x : (x == null ? [] : [x]);
  const traits = toArr(m.traits).map(t => (typeof t === 'object' && t ? t : { name: String(t), text: '' }));
  const actions = toArr(m.actions).map(a => (typeof a === 'object' && a ? a : { name: String(a) }));
  const spells  = toArr(m.spells);
  const languages = toArr(m.languages);
  const resistances = toArr(m.resistances);
  const immunities  = toArr(m.immunities);
  const vulnerabilities = toArr(m.vulnerabilities);
  const conditions = toArr(m.conditions);

  // Inventory normalization
  const inv = m.inventory && typeof m.inventory === 'object' ? m.inventory : {};
  const coins = inv.coins && typeof inv.coins === 'object' ? inv.coins : {};
  const items = toArr(inv.items);

  // HP normalization
  const hpIn = m.hp && typeof m.hp === 'object' ? m.hp : {};
  const hp = {
    current: Number(hpIn.current ?? 1),
    max:     Number(hpIn.max ?? 1),
    temp:    Number(hpIn.temp ?? 0)
  };

  // Stats normalization
  const s = m.stats && typeof m.stats === 'object' ? m.stats : {};
  const stats = {
    str: Number(s.str ?? 10),
    dex: Number(s.dex ?? 10),
    con: Number(s.con ?? 10),
    int: Number(s.int ?? 10),
    wis: Number(s.wis ?? 10),
    cha: Number(s.cha ?? 10),
  };

  // Ensure actions have sensible defaults for the UI
  const safeActions = actions.length ? actions : [{
    name: 'Weapon Attack',
    type: 'weapon',
    range: '5 ft',
    attackBonus: modFromStat(stats.str) + 2,
    damage: [{ dice: '1d6+2', type: 'slashing' }],
    notes: 'Basic attack'
  }];

  return {
    id: m.id || uuidv4(),
    name: m.name || 'Unnamed',
    level: Number(m.level ?? appState.encounter.levelTarget ?? 3),
    ac: Number(m.ac ?? 12),
    hp,
    movement,
    initiative: m.initiative ?? '',
    stats,
    saves: (m.saves && typeof m.saves === 'object') ? m.saves : {},
    skills: (m.skills && typeof m.skills === 'object') ? m.skills : {},
    senses,
    languages,
    resistances,
    immunities,
    vulnerabilities,
    traits,
    actions: safeActions,
    spells,
    inventory: { coins: { cp: Number(coins.cp||0), sp: Number(coins.sp||0), gp: Number(coins.gp||0), pp: Number(coins.pp||0) }, items },
    conditions,
    concentration: (m.concentration && typeof m.concentration === 'object') ? m.concentration : null,
    deathSaves: (m.deathSaves && typeof m.deathSaves === 'object') ? { success: Number(m.deathSaves.success||0), fail: Number(m.deathSaves.fail||0) } : { success: 0, fail: 0 },
    notes: m.notes || ''
  };
}



    function buildUserPrompt(levelTarget,levelVariation,wealthTier,styleAll,speciesSel,party,difficulty){
      return `Inputs:
- Level target: ${levelTarget} (±${levelVariation})
- Species: ${speciesSel.join(', ')}
- Style: ${styleAll.join(', ')}
- Wealth: ${wealthTier}
- Party: ${party.pcCount} PCs at avg level ${party.averageLevel}, difficulty ${difficulty}

Return a single JSON object with keys: schemaVersion (number), party, encounter, mobs (array of 3–6 items). Each mob includes: id, name, level, ac, hp{current,max,temp}, movement, initiative, stats{str,dex,con,int,wis,cha}, saves, skills, senses, languages, resistances, immunities, vulnerabilities, traits[{name,text}], actions[{name,type,range,attackBonus,damage[{dice,type}],save{dc,ability},effect,notes}], spells[], inventory{coins{cp,sp,gp,pp},items[]}, conditions[], concentration or null, deathSaves{success,fail}, notes.`
    }
    async function requestChatCompletions(apiKey, messages, responseFormat){
      const body={model:'gpt-4o-mini', messages, temperature:0.7};
      if(responseFormat) body.response_format=responseFormat;
      const headers = new Headers();
      headers.set('Authorization', `Bearer ${apiKey}`);
      headers.set('Content-Type', 'application/json');
      
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers,            // <— use the Headers instance
        body: JSON.stringify(body)
      });
      if(!res.ok){const t=await res.text(); throw new Error(`OpenAI error ${res.status}: ${t}`)}
      const data=await res.json();
      const text=data?.choices?.[0]?.message?.content;
      if(!text) throw new Error('No content in response');
      return text;
    }

    // Strip zero-width / smart spaces / non-ASCII from the API key
    function cleanApiKey(raw){
      if (!raw) return "";
      let s = String(raw);

      // Trim whitespace (including Unicode)
      s = s.trim();

      // Remove leading BOM if present
      if (s.charCodeAt(0) === 0xFEFF) s = s.slice(1);

      // Strip surrounding quotes if pasted with " or '
      if ((s.startsWith('"') && s.endsWith('"')) ||
          (s.startsWith("'") && s.endsWith("'"))) {
        s = s.slice(1, -1);
      }

      // Remove any character outside ISO-8859-1 printable range
      s = s.replace(/[^\u0020-\u007E\u00A0-\u00FF]/g, "");

      console.log(s)

      return s;
    }

    async function generateEncounter(){
      const apiKey=cleanApiKey($('#apiKey').value.trim()); if(!apiKey){alert('Enter your OpenAI API key first.');return}
      // Gather inputs
      const levelTarget=Number($('#levelTarget').value||1), levelVariation=Number($('#levelVariation').value||0), wealthTier=$('#wealthTier').value;
      const style=$$('#topbar input.form-check-input:checked').map(c=>c.value);
      const freeTags=($('#styleFree').value||'').split(',').map(s=>s.trim()).filter(Boolean); const styleAll=[...new Set([...style,...freeTags])];
      const speciesSel=Array.from($('#speciesSelect').selectedOptions).map(o=>o.value);
      const party={pcCount:Number($('#pcCount').value||4), averageLevel:Number($('#avgLevel').value||3)};
      const difficulty=$('#difficulty').value;
      appState.encounter={seed:freeTags.join(', '), style:styleAll.length?styleAll:['dungeon'], species:speciesSel.length?speciesSel:['Mixed'], wealthTier, levelTarget, levelVariation, mix:'balanced', difficulty};
      appState.party.pcCount=party.pcCount; appState.party.averageLevel=party.averageLevel;

      const systemPrompt=`You generate compact, ready-to-run D&D 5e-style enemy mobs for a Dungeon Master.
Constraints:
- Output MUST be valid JSON (no markdown fences).
- Populate fields realistically, consistent with level and style.
- Provide 3–6 mobs unless inputs strongly suggest otherwise.
- Actions include to-hit bonuses and damage dice where relevant.
- Inventory reflects wealth tier. Use UUID-like ids.`;
      const userPrompt=buildUserPrompt(levelTarget,levelVariation,wealthTier,styleAll,speciesSel,party,difficulty);

      try{
        // Try strict JSON schema format first (newer models). If it fails, fall back to json_object, then plain text.
        let text=null;
        try{
          text=await requestChatCompletions(apiKey,[
            {role:'system',content:systemPrompt},
            {role:'user',content:userPrompt}
          ], {type:'json_object'});
        }catch(e1){
          // Fallback: plain text, but instruct again to return JSON only
          text=await requestChatCompletions(apiKey,[
            {role:'system',content:systemPrompt+'\nReturn ONLY a JSON object, no commentary.'},
            {role:'user',content:userPrompt+'\nReturn ONLY JSON.'}
          ]);
        }

        // Parse JSON
        let parsed=null;
        try{ parsed=JSON.parse(text) }catch(e){ // last resort: extract with regex
          const m=text.match(/{(?:[^{}]|{[^{}]*})*}/s); if(m){parsed=JSON.parse(m[0])} else { throw e }
        }
        if (parsed.party && typeof parsed.party === 'object') {
          const p = parsed.party;
          // Accept both pcCount/averageLevel and size/avgLevel
          parsed.party = {
            pcCount: Number(p.pcCount ?? p.size ?? appState.party.pcCount ?? 4),
            averageLevel: Number(p.averageLevel ?? p.avgLevel ?? appState.party.averageLevel ?? 3),
            playersInitiative: Array.isArray(p.playersInitiative) ? p.playersInitiative : []
          };
        }
        if(!parsed?.mobs) throw new Error('No mobs in response.');

        appState.schemaVersion=SCHEMA_VERSION;
        appState.party=parsed.party||appState.party;
        appState.encounter=parsed.encounter||appState.encounter;
        appState.mobs=(parsed.mobs||[]).map(normalizeMob);

        saveStateToCookie(); renderPlayers(); renderMobs(); renderInitiativeOrder();
        showActionToast({title:'Encounter ready', body:`<div class="monosmall">${appState.mobs.length} mobs generated.</div>`, durationMs:8000});
      }catch(err){
        console.error(err);
        const hint=(String(err).includes('Failed to fetch')||String(err).includes('NetworkError'))?
          `<div class="mt-2 small text-secondary">Hint: Serve this file via HTTP(S) (e.g. <code>python -m http.server</code>) or GitHub Pages. Some browsers block API calls from <code>file://</code>.</div>`:'';
        showActionToast({title:'Generation failed', body:`<div class="monosmall text-danger">${(err&&err.message)||String(err)}</div>${hint}`, durationMs:20000});
      }
    }

    // ---------- init ----------
    document.addEventListener('DOMContentLoaded',()=>{
      if(location.protocol==='file:') document.getElementById('banner').classList.remove('d-none');
      loadStateFromCookie(); const k=getCookie(CK_API_KEY); if(k) $('#apiKey').value=k;
      $('#levelTarget').value=appState.encounter.levelTarget??3; $('#levelVariation').value=appState.encounter.levelVariation??1; $('#wealthTier').value=appState.encounter.wealthTier??'Modest';
      $('#pcCount').value=appState.party.pcCount??4; $('#avgLevel').value=appState.party.averageLevel??3; $('#difficulty').value=appState.encounter.difficulty??'Medium';
      $$('#topbar input.form-check-input').forEach(c=>c.checked=appState.encounter.style?.includes(c.value)); $('#styleFree').value=appState.encounter.seed??'';
      const setSpecies=new Set(appState.encounter.species||['Human']); Array.from($('#speciesSelect').options).forEach(o=>{if(setSpecies.has(o.value)) o.selected=true});
      renderPlayers(); renderMobs(); renderInitiativeOrder();

      $('#btnSaveKey').addEventListener('click',()=>{setCookie(CK_API_KEY,cleanApiKey($('#apiKey').value.trim())); showActionToast({title:'API key', body:'<div class="monosmall">Saved to cookie.</div>', durationMs:4000})});
      $('#btnForgetKey').addEventListener('click',()=>{eraseCookie(CK_API_KEY); $('#apiKey').value=''; showActionToast({title:'API key', body:'<div class="monosmall">Forgotten.</div>', durationMs:4000})});
      $('#btnGenerate').addEventListener('click',generateEncounter);

      $('#btnAddPlayer').addEventListener('click',()=>{const name=$('#playerName').value.trim(); const init=Number($('#playerInit').value||0); if(!name) return;
        appState.party.playersInitiative.push({name,init}); $('#playerName').value=''; $('#playerInit').value=''; saveStateToCookie(); renderPlayers(); renderInitiativeOrder()});
      $('#btnRollAllInit').addEventListener('click',rollAllMobInitiatives);
      $('#btnClearInits').addEventListener('click',()=>{appState.mobs.forEach(m=>m.initiative=''); appState.party.playersInitiative.forEach(p=>p.init=''); saveStateToCookie(); renderInitiativeOrder()});
      $('#btnExport').addEventListener('click',exportJSON);
      $('#btnImport').addEventListener('click',()=>new bootstrap.Modal('#importModal').show());
      $('#btnDoImport').addEventListener('click',importJSONFromText);
      $('#btnCopyExport').addEventListener('click',()=>navigator.clipboard.writeText($('#exportText').value));
      $('#btnSaveAll').addEventListener('click',()=>{saveStateToCookie(); showActionToast({title:'Saved',body:'<div class="monosmall">Encounter saved to cookies.</div>',durationMs:4000})});
      $('#btnForgetAll').addEventListener('click',()=>{if(confirm('This will clear the encounter from cookies. Continue?')){eraseCookie(CK_APP_STATE); appState.mobs=[]; saveStateToCookie(); renderMobs(); renderInitiativeOrder()}});
      $$('.filterAlive').forEach(cb=>cb.addEventListener('change',renderMobs));
      $('#searchInput').addEventListener('input',renderMobs);
      $('#btnClearSearch').addEventListener('click',()=>{$('#searchInput').value=''; renderMobs()});
      document.addEventListener('keydown',e=>{if(e.key==='r'||e.key==='R') rollAllMobInitiatives(); if(e.key==='/'){e.preventDefault(); $('#searchInput').focus()}});
    });
  </script>
</body>
</html>
